%
% iMath.sty --- macros for Mathematical computing and printing
% (C) 2010-2014 Kentaro YOSHITOMI(yositomi (at) las.osakafu-u.ac.jp)
\def\iMath@Date{Time-stamp: "2014/12/12"}
\def\iMath@Revision{0.91}
\def\@get@rev Time-stamp: "#1"\relax{\gdef\@time@{#1}}
\expandafter\@get@rev \iMath@Date\relax
% \ProvidesPackage{iMath}[\@year@/@month@/\@day@ \iMath@Revision]
\ProvidesPackage{iMath}[\@time@ \iMath@Revision]
% MIT License applied.
% not use perl, but can be used with emath, KETpic, PariGP, 
% Mathematica, etc...(maybe)
% \NeedsTeXFormat{LaTeX2e} ... usable under lualatex, latex3(?), latex2e 
% \ProvidesPackage{iMath}[2014/04/22 v0.0]%%% 仕様変更注意
\makeatletter
\newcount\rnd@i
\newcount\rnd@j
\newcount\im@i
\newcount\im@j
%%% Original Counter Method
\def\imNewCount#1{%
  \expandafter\newcount\csname @im:#1\endcsname}
\def\imSetCount#1#2{%
  \expandafter\relax\csname @im:#1\endcsname=#2\relax}
\def\imGetCount#1{%
  \expandafter\number\csname @im:#1\endcsname}
\def\imAdvance#1#2{%
  \expandafter\advance\csname @im:#1\endcsname#2}
\def\imMultiply#1#2{%
  \expandafter\multiply\csname @im:#1\endcsname by #2}
\def\imDivide#1#2{%
  \expandafter\divide\csname @im:#1\endcsname by #2}
%%% Array %%%
%%% Declare Array #2 size of #1
\def\NewArray#1#2{%% 
  \expandafter\xdef\csname #2:@attr@\endcsname{NumericalArray,Starting1}%
  \expandafter\xdef\csname #2:0\endcsname{#1}%
  \expandafter\xdef\csname #2:size\endcsname{#1}%
  \@tempcnta\z@\relax
  \@tempcntb=#1\relax\advance\@tempcntb\@ne\relax
  \@whilenum\@tempcnta < \@tempcntb \do{%%
    \advance\@tempcnta\@ne\relax
    \expandafter\xdef\csname #2:\number\@tempcnta\endcsname{0}}
  \expandafter\gdef\csname #2\endcsname[##1]{\csname #2:##1\endcsname}%
  \expandafter\gdef\csname get#2\endcsname##1{\csname #2:##1\endcsname}%
  \expandafter\gdef\csname set#2\endcsname##1##2{%
    \expandafter\xdef\csname #2:##1\endcsname{##2}}%
  \expandafter\gdef\csname attr#2\endcsname{\csname #2:@attr@\endcscname}%
}
%%% Declare Associative Array
\def\NewAssocArray#1#2{%%
  \expandafter\xdef\csname #2:@attr@\endcsname{AssocArray,Keys:#1}%
  \expandafter\xdef\csname #2:@keys@\endcsname{#1}%
  \@tempcnta\z@\relax
  \@for\x:=#1\do{%
    \expandafter\xdef\csname #2:\x\endcsname{\x}%
    \advance\@tempcnta\@ne}%
  \expandafter\xdef\csname #2:@size@\endcsname{\number\@tempcnta}%
  \expandafter\gdef\csname #2\endcsname[##1]{\csname #2:##1\endcsname}%
  \expandafter\gdef\csname get#2\endcsname##1{\csname #2:##1\endcsname}%
  \expandafter\gdef\csname set#2\endcsname##1##2{%
    \@ifundefined{#2:##1}{\message{Warning:accessed for non-defined key}}{}%
    \expandafter\xdef\csname #2:##1\endcsname{##2}}%
  \expandafter\gdef\csname setall#2\endcsname##1{%
    \NewArray{\csname #2:@size@\endcsname}{im@aa}%
    \xdef\im@tmp@keys{\csname #2:@keys@\endcsname}%
    \@tempcnta\z@\relax
    \@for\im@k:=##1\do{%
      \advance\@tempcnta\@ne\relax
      \setim@aa{\number\@tempcnta}{\im@k}}
    \@tempcnta\z@\relax
    \@for\im@k:=\im@tmp@keys\do{%
      \advance\@tempcnta\@ne\relax
      \expandafter\xdef\csname #2:\im@k\endcsname{%
        \im@aa[\number\@tempcnta]}}}%
  \expandafter\gdef\csname attr#2\endcsname{\csname #2:@attr@\endcscname}%
  \expandafter\gdef\csname key#2\endcsname{\csname #2:@keys@\endcsname}%
}
\def\ReverseCSV#1#2{
  \@tempcnta\z@\relax
  \@for\@x:=#1\do{\advance\@tempcnta\@ne\imPushStack\@x}%
  \xdef\im@ret{}\edef\im@m{\number\@tempcnta}\@tempcnta\z@\relax
  \@whilenum \@tempcnta < \im@m \do{%
    \imPopStack\im@i%
    \ifnum\@tempcnta=0\xdef\im@ret{\im@i}%
    \else\xdef\im@ret{\im@ret,\im@i}\fi
    \advance\@tempcnta\@ne\relax
  }%
  \xdef#2{\im@ret}%
}
\def\ReverseSTR#1#2{
  \@tempcnta\z@\relax
  \@tfor\@x:=#1\do{\advance\@tempcnta\@ne\imPushStack\@x}%
  \xdef\im@ret{}\edef\im@m{\number\@tempcnta}\@tempcnta\z@\relax
  \@whilenum \@tempcnta < \im@m \do{%
    \imPopStack\im@i%
    \ifnum\@tempcnta=0\xdef\im@ret{\im@i}%
    \else\xdef\im@ret{\im@ret\im@i}\fi
    \advance\@tempcnta\@ne\relax
  }%
  \xdef#2{\im@ret}%
}
%%% Original Stack Frame
\newcount\im@stack@ct
\im@stack@ct\z@
\def\imPushStack#1{%
  \advance\im@stack@ct\@ne\relax
  \def\im@stack@ct@num{\number\im@stack@ct}%
  \expandafter\xdef\csname im@\im@stack@ct@num\endcsname{#1}}%
\def\imPopStack#1{%
  \ifnum\im@stack@ct>0
  \def\im@stack@ct@num{\number\im@stack@ct}%
  \xdef#1{\csname im@\im@stack@ct@num\endcsname}%
  \advance\im@stack@ct\m@ne\relax
  \else
  \message{Err:stack empty}%
  \fi}%
%%% Basic Integer Arithmetic including Modulo and Power function
\def\im@add#1#2#3{%%%
  \@tempcnta=#1\advance\@tempcnta #2\xdef#3{\number\@tempcnta}}
\def\im@sub#1#2#3{%%%
  \@tempcnta=#1\advance\@tempcnta -#2\xdef#3{\number\@tempcnta}}
\def\im@mul#1#2#3{%%%
  \@tempcnta=#1\multiply\@tempcnta by #2\xdef#3{\number\@tempcnta}}  
\def\im@div#1#2#3{%%%
  \@tempcnta=#1\divide\@tempcnta by #2\xdef#3{\number\@tempcnta}}  
\def\im@mod#1#2#3{%%%
  % \expandafter\@tmp@la@i #1\im@i=\number\@tmp@la@i\relax
  % \expandafter\@tmp@la@j #1\im@j=\number\@tmp@la@j\relax
  % \divide\im@i #2\multiply\im@i by -#2
  % \advance\im@j\im@i\xdef#3{\number\im@j}%
  \expandafter\im@i #1\relax
  \expandafter\im@j #1\relax
  \divide\im@i #2\multiply\im@i by -#2
  \advance\im@j\im@i\xdef#3{\number\im@j}}  
\def\im@pow{\@ifnextchar[%%%]
  {\@im@pow}{\@im@pow[0]}}
\def\@im@pow[#1]#2#3#4{% #3=#1^#2
  \def\im@tmp@r{1}\xdef\im@tmp@a{#2}\xdef\im@tmp@b{#3}%
  \xdef\im@tmp@m{#1}%
  \@whilenum \im@tmp@b > 0 \do{%
    \im@mod\im@tmp@b2\im@tmp@f%
    \ifcase\im@tmp@f\or\im@mul\im@tmp@r\im@tmp@a\im@tmp@r\relax
    \ifnum\im@tmp@m > 0\im@mod\im@tmp@r\im@tmp@m\im@tmp@r\fi\fi
    \im@mul\im@tmp@a\im@tmp@a\im@tmp@a%
    \ifnum\im@tmp@m > 0\im@mod\im@tmp@a\im@tmp@m\im@tmp@a\fi
    \im@div\im@tmp@b2\im@tmp@b%
  }%
  \xdef#4{\im@tmp@r}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Alias \ZAdd 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\let\ZAdd\im@add\relax\let\ZSub\im@sub\relax
\let\ZMul\im@mul\relax\let\ZDiv\im@div\relax
\let\ZMod\im@mod\relax\let\ZPow\im@pow\relax
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% CallPariGP : use CAS (e.g. Pari/GP) with \@@input cmd(tex:\input)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\CallPariGP#1#2{% #1 = random seed
  \begingroup\makeatletter\endlinechar=\m@ne\everyeof{\noexpand}
  \edef\@@x{\endgroup\def\noexpand#2{\@@input|"echo '#1'|gp -q" }
  }\@@x
}
%%%%%% GetGCD #3 = GCD(#1,#2) %%%%%
\def\GetGCD#1#2#3{%%%
  \def\@@tmp@a{#1}\def\@@tmp@b{#2}%%%
  \ifnum \@@tmp@a<0 \im@mul\@@tmp@a{-1}\@@tmp@a\fi
  \ifnum \@@tmp@b<0 \im@mul\@@tmp@b{-1}\@@tmp@b\fi
  \ifnum \@@tmp@a<\@@tmp@b
  \edef\@tmp@a{\@@tmp@b}\relax\edef\@tmp@b{\@@tmp@a}%%%
  \else
  \edef\@tmp@a{\@@tmp@a}\relax\edef\@tmp@b{\@@tmp@b}%%%
  \fi%
  \ifnum\@tmp@b = 0
  \xdef#3{\@tmp@a}%%%
  \else
  \im@mod\@tmp@a\@tmp@b\@tmp@r%
  \@whilenum \@tmp@r > 0 \do {%%%
    \edef\@tmp@a{\@tmp@b}%%%
    \edef\@tmp@b{\@tmp@r}%%%
    \im@mod\@tmp@a\@tmp@b\@tmp@r
  }%%%
  \xdef#3{\@tmp@b}%%%
  \fi%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% Rational Number Arithmetic \QAdd,\QSub,\QMul,\QDiv,\QPow %%%%%
%%%%% Rational Number Printing \QFrac,
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% a/b か a か (check if the string has / , without numerical check)
\def\@has@slash#1\relax{TT\fi
  \def\@@flag{0}\def\@@true{1}%%%
  \def\@slash{/}%%%
  \@tfor\@x:=#1\do{%%%
    \if\@x\@slash\def\@@flag{1}\fi
  }%%%
  \if\@@flag\@@true
}
\def\IfHasSlash#1#2#3{%%% #1:csname, #2:true, #3:false
  \edef\@arg{#1}%%%
  \if\expandafter\@has@slash\@arg\relax%%%
  #2\else #3\fi
}
\let\IfNotInt\IfHasSlash%%% same as IfHasSlash
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\sl@numden#1/#2:#3{%%%
  \expandafter\gdef\csname #3num\endcsname{#1}%%%
  \expandafter\gdef\csname #3den\endcsname{#2}%%%
}
\def\RatNumDen#1{%%%
  \edef\tmp@arg{\csname #1\endcsname}%%%
  % tmp@arg = \tmp@arg
  \IfHasSlash\tmp@arg{\expandafter\sl@numden\tmp@arg:{#1}}%%%
  {\expandafter\sl@numden\tmp@arg/1:{#1}}%%%
}
\def\QRed#1{%%%
  \edef\tmp@A{#1}%%%
  \RatNumDen{tmp@A}
  \GetGCD\tmp@Aden\tmp@Anum\tmp@Ag
  \im@div\tmp@Aden\tmp@Ag\tmp@Aden
  \im@div\tmp@Anum\tmp@Ag\tmp@Anum
  \ifnum\tmp@Aden < 0 
  \im@mul\tmp@Anum{-1}\tmp@Anum
  \im@mul\tmp@Aden{-1}\tmp@Aden
  \fi
  \ifnum\tmp@Aden>1
  \edef#1{\tmp@Anum/\tmp@Aden}%%%
  \else
  \edef#1{\tmp@Anum}%%%
  \fi
}
\def\QAdd#1#2#3{%%%
  \def\tmp@A{#1}\def\tmp@B{#2}%%%
  \RatNumDen{tmp@A}\RatNumDen{tmp@B}%%%
  \im@mul\tmp@Aden\tmp@Bden\tmp@Cden
  \im@mul\tmp@Anum\tmp@Bden\tmp@CnumA
  \im@mul\tmp@Aden\tmp@Bnum\tmp@CnumB
  \im@add\tmp@CnumA\tmp@CnumB\tmp@Cnum%%%
  \GetGCD\tmp@Cnum\tmp@Cden\tmp@Cg%%%
  \im@div\tmp@Cnum\tmp@Cg\tmp@Cnum
  \im@div\tmp@Cden\tmp@Cg\tmp@Cden
  \ifnum\tmp@Cden=1
  \edef#3{\tmp@Cnum}%%%
  \else
  \edef#3{\tmp@Cnum/\tmp@Cden}%%%
  \fi
}
\def\QMul#1#2#3{%%%
  \def\tmp@A{#1}\def\tmp@B{#2}%%%
  \RatNumDen{tmp@A}\RatNumDen{tmp@B}%%%
  \im@mul\tmp@Aden\tmp@Bden\tmp@Cden%%%
  \im@mul\tmp@Anum\tmp@Bnum\tmp@Cnum%%%
  \GetGCD\tmp@Cnum\tmp@Cden\tmp@Cg%%%
  \im@div\tmp@Cnum\tmp@Cg\tmp@Cnum
  \im@div\tmp@Cden\tmp@Cg\tmp@Cden
  \ifnum\tmp@Cden=1
  \edef#3{\tmp@Cnum}%%%
  \else
  \edef#3{\tmp@Cnum/\tmp@Cden}%%%
  \fi
}
\def\QSub#1#2#3{%%%
  \def\tmp@A{#1}\def\tmp@B{#2}%%%
  \RatNumDen{tmp@A}\RatNumDen{tmp@B}%%%
  \im@mul\tmp@Bnum{-1}\tmp@Bnum%%%
  \im@mul\tmp@Aden\tmp@Bden\tmp@Cden
  \im@mul\tmp@Anum\tmp@Bden\tmp@CnumA
  \im@mul\tmp@Aden\tmp@Bnum\tmp@CnumB
  \im@add\tmp@CnumA\tmp@CnumB\tmp@Cnum%%%
  \GetGCD\tmp@Cnum\tmp@Cden\tmp@Cg%%%
  \im@div\tmp@Cnum\tmp@Cg\tmp@Cnum
  \im@div\tmp@Cden\tmp@Cg\tmp@Cden
  \ifnum\tmp@Cden=1
  \edef#3{\tmp@Cnum}%%%
  \else
  \edef#3{\tmp@Cnum/\tmp@Cden}%%%
  \fi
}
\def\QDiv#1#2#3{%%%
  \def\tmp@A{#1}\def\tmp@B{#2}%%%
  \RatNumDen{tmp@A}\RatNumDen{tmp@B}%%%
  \im@mul\tmp@Aden\tmp@Bnum\tmp@Cden%%%
  \im@mul\tmp@Anum\tmp@Bden\tmp@Cnum%%%
  \ifnum\tmp@Cden < 0 
  \im@mul\tmp@Cden{-1}\tmp@Cden
  \im@mul\tmp@Cnum{-1}\tmp@Cnum
  \fi
  \GetGCD\tmp@Cnum\tmp@Cden\tmp@Cg%%%
  \im@div\tmp@Cnum\tmp@Cg\tmp@Cnum%%%
  \im@div\tmp@Cden\tmp@Cg\tmp@Cden%%%
  \ifnum\tmp@Cden=1
  \edef#3{\tmp@Cnum}%%%
  \else
  \edef#3{\tmp@Cnum/\tmp@Cden}%%%
  \fi
}
\def\QInv#1{%%%
  \QDiv{1}{#1}\@@a
  \edef#1{\@@a}
}
% \def\QFrac#1#2{\def\tmp@A{#1}%%%
%   \RatNumDen{tmp@A}%%%
%   \csname #2\endcsname{\tmp@Anum}{\tmp@Aden}
% }
\gdef\@fraccmd{frac}
\def\SetFracCmd#1{%%%
  \gdef\@fraccmd{#1}%%%
}
\def\QFrac#1{%%%
  \def\tmp@A{#1}%%%
  \RatNumDen{tmp@A}%%%
  \ifnum\tmp@Anum<0\im@mul\tmp@Anum{-1}\tmp@Anum\def\tmp@sig{-}
  \else\def\tmp@sig{}\fi
  \ifnum\tmp@Aden>1
  \tmp@sig\csname\@fraccmd\endcsname%
  {\,\tmp@Anum\,}{\,\tmp@Aden\,}%%%
  \else
  \tmp@sig\tmp@Anum%%%
  \fi
}
\def\QFracP#1{%%% QFrac with ( ) if negative
  \def\tmp@A{#1}\relax\RatNumDen{tmp@A}%%%
  \ifnum\tmp@Anum<0\left(\QFrac#1\right)\else
  \QFrac#1\fi
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%% random number related (experimental) 
%%%%% Use '.lmr' for file name exttention to save the ramdom seed
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\gdef\@use@pari{0}
\def\UsePari{\gdef\@use@pari{1}}
\def\NotUsePari{\gdef\@use@pari{0}}
\def\iM@RP{301003151}% prime(10)^2*prime(20)^3
\def\im@RA{2060}% prime(10)*prime(20)+1
\def\im@RB{20677}% 10000000-th prime, the b of recursion formula 'ax+b'
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%% If you use pre-defined seed file, each value of which is
%%% in the range 0 - max-1, set the value to the max.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\@RSEED@MAX{32768}%%%% default max
\def\SetRSeedMax#1{\gdef\@RSEED@MAX{#1}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\gdef\@RSeed{}%%%
\def\@get@random@seed@ne#1{% #1 = random seed
  \begingroup\makeatletter\endlinechar=\m@ne\everyeof{\noexpand}%%%
  \ifcase\@use@pari%%% Not use pari
  \IfFileExists{/dev/uraondom}{%%%
    \gdef\@RSEED@MAX{65536}%%%
    \edef\@@x{\endgroup\def\noexpand#1{%%% -N4 too big, -N2 2byte = 2^16
        \@@input|"od -vAn -N2 -tu8 </dev/urandom|sed 's/ //g'|sed '/^$/d'" }%$
    }\@@x}{
    \gdef\@RSEED@MAX{32768}%% Windows: 0 ... 32767 : 2^15
    \edef\@@x{\endgroup\def\noexpand#1{%%% Windows Case
        \@@input|"echo \%RANDOM\%"}%%
    }\@@x}%%%
  \or%%% Use pari (@use@pari{1}) case
  \edef\@@x{\endgroup\def\noexpand#1{%%%
      \@@input|"echo 'random({N=2^15})'|gp -q" }
  }\@@x
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% e.g. \NewRandomSeed{50}: 50s random seed generated.
%%%%% \IRand functions use pop one of them and 
%%%%%        makes desired random integer via the IMod macro.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \def\NewRandomSeed#1{%%%
%   \gdef\@RSeed{}%%%
%   \rnd@j=0\relax\@whilenum \rnd@j < #1 \do {%%%
%     \@get@random@seed@ne\rnd@@temp%%%
%     \ifnum\rnd@j=0
%     \xdef\@RSeed{\rnd@@temp}%%%
%     \else
%     \xdef\@RSeed{\@RSeed,\rnd@@temp}%%%
%     \fi
%     \advance\rnd@j\@ne
%   }%%%
% }
% \def\PopRSeed#1{%%%
%   \@tempcnta=\z@
%   \let\random@seed\@empty
%   \expandafter\@for\expandafter\@r\expandafter:\expandafter=\@RSeed\do{%%%
%     \ifnum\@tempcnta=\z@
%     \edef#1{\@r}%%%
%     \else
%     \ifnum\@tempcnta=\@ne
%     \edef\random@seed{\@r}%%%
%     \else
%     \edef\random@seed{\random@seed,\@r}%%%
%     \fi
%     \fi
%     \advance\@tempcnta\@ne
%   }%
%   \xdef\@RSeed{\random@seed}%%%
% }
\def\SetRandomSeed#1{%%%
  \gdef\@RSeed{#1}%%% as csv
}
% \def\SaveRandomSeed{
%   \write18{echo "\gdef\ @RSeed{\@RSeed}"|sed 's/ //g' > \jobname.lmr}
% }
\def\SaveRandomSeed{%%%
  \IfFileExists{/bin/echo}{%%% NotWindowz-case ^^;
    \write18{/bin/echo "\@RSeed" > \jobname.lmr}
  }{%% Windows case: no warrantee.
    \write18{echo "\@RSeed" > \jobname.lmr}
  }
}
%%%%%%%% Windows : 'cat' does not work... need cygwin?
\def\LoadRandomSeed#1{% #1 is the filename having random seed at 1st line.
  \IfFileExists{/dev/urandom}{%%% NOT Windows
    \begingroup\makeatletter\endlinechar=\m@ne\everyeof{\noexpand}
    \edef\@@x{\endgroup\def\noexpand\@RSeed{\@@input|"cat '#1'" }%%%
    }\@@x%%%
  }{%%% Windows only
    \begingroup\makeatletter\endlinechar=\m@ne\everyeof{\noexpand}
    \edef\@@x{\endgroup\def\noexpand\@RSeed{\@@input|"type '#1'" }%%%
    }\@@x%%%
  }%%%
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% InitRandomSeed : load .lmr file or call NewRandomSeed and save
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\InitRandomSeed#1{%%%
  \rnd@i=#1
  \ifnum\rnd@i < 0 \multiply\rnd@i by -1
  \NewRandomSeed{\number\rnd@i}%%%
  \else
  \IfFileExists{\jobname.lmr}{%%%
    \LoadRandomSeed{\jobname.lmr}
  }{%%% Debug: no File case
    \NewRandomSeed{\number\rnd@i}%%%
    \SaveRandomSeed%%%
  }
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% ZRand : #3 = random integer from #1 to #2
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\ZRand#1#2#3{%%%
  \edef\@st{#1}\edef\@ed{#2}%%%
  \im@sub\@ed\@st\@range\im@add\@range1\@range
  \PopRSeed\tmp@rs%%%
  % Debug: tmp@rs = \tmp@rs
  \im@mod\tmp@rs\@range\ZR@tmp@r
  \im@add\ZR@tmp@r\@st\tmp@ret\edef#3{\tmp@ret}
}  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% IRand : emath wrapper of ZRand
\def\IRand#1#2#3{%%% emath wrapper
  \def\LA@IR@va{#1}\def\LA@IR@vb{#2}
  \ISub\LA@IR@vb\LA@IR@va\LA@IR@vc\IAdd\LA@IR@vc1\LA@IR@vc
  \Ransuu[d]{Int(X*(\LA@IR@vc))+(\LA@IR@va)}#3
}
%%%%%%%%%%%% will be obsolete below
\def\RandomInt#1#2#3{%%%
  \edef\@st{#1}\edef\@ed{#2}
  \im@sub\@ed\@st\@range\im@add\@range1\@range
  %%%%% Too long to compute inside the TeX
  % \im@div\@RSeed\@range\RI@tmp@a
  % \im@mul\@range\RI@tmp@a\RI@tmp@b
  % \im@sub\@RSeed\RI@tmp@b\RI@tmp@c
  % \xdef\@RSeed{\RI@tmp@a}
  %%%%%
  \CallPariGP{\@RSeed-\@range*floor(\@RSeed/\@range)}\RI@tmp@c
  % \im@add\RI@tmp@c\@st\@@r\edef\noexpand#3{\@@r}
  \im@add\RI@tmp@c\@st\@@r\gdef#3{\@@r}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%% RandomSelect : select randomly from CSV
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\def\RandomSelect#1#2{%%%
  \rnd@i=0\relax
  \@for\member:=#1\do{%
    \advance\rnd@i\@ne
    \def\@@i{\number\rnd@i}%
    \expandafter\def\csname rsel@tmp:\@@i\endcsname{\member}%
  }%
  \ZRand1{\number\rnd@i}\rnd@tmp%
  \edef#2{\csname rsel@tmp:\rnd@tmp\endcsname}%
}
\makeatother
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%% EOF of iMath.sty %%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
